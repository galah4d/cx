package main

import "app"
import "fps"
import "mat"
import "gfx"
import "gl" // ##1 remove gl dependency

var exit bool // ISSUE : panic when Application is global

func KeyboardCallback(window str, key i32, scancode i32, action i32, mods i32) () {
	printf("KeyboardCallback : window %s, key %d, scancode %d, action %d, mods %d\n", window, key, scancode, action, mods)
	if key == app.KEYCODE_ESCAPE && action == app.KEY_PRESS {
		exit = true
	}
}

func MouseButtonCallback(window str, key i32, action i32, mods i32) () {
	printf("MouseButtonCallback : window %s, key %d, action %d, mods %d\n", window, key, action, mods)
}

func MousePositionCallback(window str, x f64, y f64) () {
	printf("MousePositionCallback : window %s, x %f, y %f\n", window, x, y)
}

func main()() {
	var o app.Options
	o.width = 800
	o.height = 600
	o.fps = 60
	o.Parse()

	var f fps.Framerate
	f.Init(i32.f64(o.fps))

	var prfSwap fps.ProfileId = fps.CreateProfile("swap")
	var prfFrame fps.ProfileId = fps.CreateProfile("frame")
	var prfUpdate fps.ProfileId = fps.CreateProfile("update")
	var prfRender fps.ProfileId = fps.CreateProfile("render")

	var a app.Application
	a.Init(o, "Colored Quad Tutorial", "mainWindow", 2, 1)
	a.SetKeyboardCallback("main", "KeyboardCallback")
	a.SetMouseButtonCallback("main", "MouseButtonCallback")
	a.SetMousePositionCallback("main", "MousePositionCallback")

	gfx.Init(o.width, o.height, o.dataDir)

	var width f32 = i32.f32(o.width)
	var height f32 = i32.f32(o.height)

	for app.Running(&a) { // ISSUE : can't use member function
		f.BeginUpdate(2.0D)
		fps.Start(prfSwap)
		{
			a.BeginFrame()
			fps.Start(prfFrame)
			{
				// Update ...
				fps.Start(prfUpdate)
				if exit {
					a.Exit()
				}
				var mesh gfx.MeshId = gfx.MeshLock(gl.TRIANGLES, gfx.g_vertexColorAttributes, 6)

				var w f32 = 200.0 // ISSUE : can't declare using :=, compilation errors follows when f32 arguments are expected
				var h f32 = 200.0
				var x f32 =  (width - w) / 2.0
				var y f32 = (height - h) / 2.0

				gfx.MeshBegin(mesh)
				gfx.MeshAppendQuad(mesh,
						mat.v4_(x, y, w, h),
						mat.v4_(0.0, 0.0, 1.0, 1.0),
						mat.v4_(0.0, 1.0, 0.0, 1.0),
						mat.v4_(0.0, 0.0, width, height),
						0.0)

				gfx.MeshEnd(mesh)
 				fps.Stop(prfUpdate)

				// Render ...
				fps.Start(prfRender)
				gfx.EffectUse(gfx.g_fxVertexColor)
				gfx.MeshRender(mesh)
				gfx.MeshUnlock(mesh)
				fps.Stop(prfRender)
			}
			fps.Stop(prfFrame)
			a.EndFrame()
		}
		fps.Stop(prfSwap)
		f.EndUpdate()
	}

	gfx.Free()
}
